<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ íŠœë¸Œ ë™ì˜ìƒ ë¼ì´ë¸ŒëŸ¬ë¦¬</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-btn.active {
            background-color: #667eea;
            color: white;
        }

        .nav-btn:not(.active) {
            background-color: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .page {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .page.active {
            display: block;
        }
        
        .notice-box {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notice-box span {
            font-size: 20px;
            margin-top: 2px;
        }

        .notice-box p {
            margin: 0;
            color: #034c8a;
            font-weight: 500;
        }
        
        /* [ìˆ˜ì •ë¨] ê³µì§€ì‚¬í•­ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .weekly-notice-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3ì—´ ê³ ì • ê·¸ë¦¬ë“œ */
            gap: 8px; /* í•­ëª© ê°„ ê°„ê²© */
        }

        .weekly-notice-list li {
            background-color: #fff;
            border: 1px solid #d9e2ff;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .weekly-notice-list li:hover {
            background-color: #f0f8ff;
            transform: translateX(2px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .video-card:hover {
            transform: translateY(-5px);
        }

        .video-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #eee;
        }

        .video-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .video-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .video-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .meta-tag {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        .video-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .watch-btn, .copy-btn {
            flex: 1;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #000;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .copy-btn-table {
            background-color: #38b2ac;
            color: white;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            font-size: 16px;
        }

        /* ìµœê·¼ ê²€ìƒ‰ì–´ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .recent-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #e1e1e1;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .recent-header span {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .clear-recent {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .clear-recent:hover {
            background-color: #e9ecef;
        }

        .recent-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-item:hover {
            background-color: #f8f9fa;
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-text {
            color: #333;
            font-size: 14px;
        }

        .recent-delete {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .recent-delete:hover {
            background-color: #e9ecef;
            color: #666;
        }

        .status-indicator {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-success {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ ìœ íŠœë¸Œ ë™ì˜ìƒ ë¼ì´ë¸ŒëŸ¬ë¦¬</h1>
            <p>Firebaseë¡œ ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ê¸°í™”</p>
        </div>

        <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
        <div id="connection-status" class="status-indicator" style="display: none;"></div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showPage('search', this)">ğŸ” ê²€ìƒ‰</button>
            <button class="nav-btn" onclick="showPage('manage', this)">âš™ï¸ DB ê´€ë¦¬</button>
        </div>

        <!-- ê²€ìƒ‰ í˜ì´ì§€ -->
        <div id="search-page" class="page active">
            <h2>ê¸ˆì£¼ ì—…ë¡œë“œì˜ìƒ </h2>
            
            <!-- ì£¼ê°„ ë“±ë¡ ì •ë³´ ê³µì§€ì‚¬í•­ -->
            <div id="weekly-notice" class="notice-box">
                <span>ğŸ“¢</span>
                <div id="weekly-notice-content">
                    <p>ì´ë²ˆ ì£¼ ì‹ ê·œ ë“±ë¡ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: end;">
                <div class="form-group" style="flex: 1; margin-bottom: 0; position: relative;">
                     <h2><label>í†µí•© ê²€ìƒ‰</label> </h2>h2>
                    <input type="text" id="unified-search" placeholder="ë‚˜ë¼, ì§€ì—­, ë¸Œëœë“œ, ìƒí’ˆëª…, íƒœê·¸ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”" 
                           oninput="handleRealTimeSearch()" onkeypress="handleEnterKey(event)" onfocus="showRecentSearches()" onblur="hideRecentSearches()">
                    
                    <!-- ìµœê·¼ ê²€ìƒ‰ì–´ ë“œë¡­ë‹¤ìš´ -->
                    <div id="recent-searches" class="recent-dropdown" style="display: none;">
                        <div class="recent-header">
                            <span>ìµœê·¼ ê²€ìƒ‰ì–´</span>
                            <button onclick="clearRecentSearches()" class="clear-recent">ì „ì²´ì‚­ì œ</button>
                        </div>
                        <div id="recent-list"></div>
                    </div>
                </div>
                <button class="btn" onclick="searchVideos()" style="height: 46px;">ê²€ìƒ‰</button>
            </div>

            <!-- ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ -->
            <div id="search-count" style="margin-bottom: 15px; color: #666; display: none;">
                <span id="result-count">0</span>ê°œì˜ ê²€ìƒ‰ ê²°ê³¼
            </div>

            <div id="search-results">
                <div class="loading">Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- DB ê´€ë¦¬ í˜ì´ì§€ -->
        <div id="manage-page" class="page">
            <h2>DB ê´€ë¦¬</h2>
            
            <div class="form-group">
                <label>ìœ íŠœë¸Œ URL *</label>
                <input type="url" id="youtube-url" placeholder="https://www.youtube.com/watch?v=..." required>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="form-group">
                    <label>ë‚˜ë¼</label>
                    <input type="text" id="country" placeholder="ì˜ˆ: ì¼ë³¸">
                </div>
                <div class="form-group">
                    <label>ì§€ì—­</label>
                    <input type="text" id="region" placeholder="ì˜ˆ: ë„ì¿„">
                </div>
                <div class="form-group">
                    <label>ë¸Œëœë“œ</label>
                    <input type="text" id="brand" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤">
                </div>
                <div class="form-group">
                    <label>ìƒí’ˆëª…</label>
                    <input type="text" id="product" placeholder="ì˜ˆ: ì‚¬ì¿ ë¼ ë¼ë–¼">
                </div>
                <div class="form-group">
                    <label>íƒœê·¸</label>
                    <input type="text" id="tag" placeholder="ì˜ˆ: ë¦¬ë·°, ë§›ì§‘">
                </div>
            </div>

            <div style="margin: 20px 0;">
                <button class="btn" onclick="addVideo()" id="add-btn">ì¶”ê°€</button>
                <button class="btn" onclick="updateVideo()" id="update-btn" style="display: none;">ìˆ˜ì •</button>
                <button class="btn btn-danger" onclick="cancelEdit()" id="cancel-btn" style="display: none;">ì·¨ì†Œ</button>
            </div>

            <div id="manage-status"></div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ìœ íŠœë¸Œ URL</th>
                        <th>ë‚˜ë¼</th>
                        <th>ì§€ì—­</th>
                        <th>ë¸Œëœë“œ</th>
                        <th>ìƒí’ˆëª…</th>
                        <th>íƒœê·¸</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <tr>
                        <td colspan="7" class="loading">Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let db = null;
        let auth = null;
        let videos = [];
        let editingIndex = -1;
        let editingId = null;
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches')) || [];
        let searchTimeout = null;
        let isLoading = false;

        // Firebase ì´ˆê¸°í™”
        async function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyDF70fNUcEba4YQCLpGiPq75P9_gh9T6kY",
                authDomain: "utube-ebd4e.firebaseapp.com",
                projectId: "utube-ebd4e",
                storageBucket: "utube-ebd4e.appspot.com",
                messagingSenderId: "7974965672",
                appId: "1:7974965672:web:862548a6a5be4093988d9d",
                measurementId: "G-PDZX6N7NNJ"
            };

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                auth = firebase.auth();

                // ìµëª… ë¡œê·¸ì¸
                await auth.signInAnonymously();
                console.log("Firebase ìµëª… ë¡œê·¸ì¸ ì„±ê³µ");
                
                showConnectionStatus("Firebaseì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤", "connected");
                
                // ë°ì´í„° ë¡œë“œ
                await loadVideosFromFirestore();
                
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
                showConnectionStatus("Firebase ì—°ê²° ì‹¤íŒ¨: " + error.message, "error");
                showOfflineMessage();
            }
        }

        // ì—°ê²° ìƒíƒœ í‘œì‹œ
        function showConnectionStatus(message, type) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = message;
            statusElement.className = 'status-indicator status-' + type;
            statusElement.style.display = 'block';
            
            if (type === 'connected') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // ê´€ë¦¬ ìƒíƒœ í‘œì‹œ
        function showManageStatus(message, type) {
            const statusElement = document.getElementById('manage-status');
            statusElement.textContent = message;
            statusElement.className = 'status-indicator status-' + type;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // ì˜¤í”„ë¼ì¸ ë©”ì‹œì§€ í‘œì‹œ
        function showOfflineMessage() {
            document.getElementById('search-results').innerHTML = '<div class="error">Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
            document.getElementById('data-table-body').innerHTML = '<tr><td colspan="7" class="error">Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }

        // ì£¼ê°„ ë“±ë¡ ì •ë³´ ê³µì§€ì‚¬í•­ ë° ë¦¬ìŠ¤íŠ¸ í‘œì‹œ í•¨ìˆ˜
        function displayWeeklyNotice() {
            const noticeContentElement = document.getElementById('weekly-notice-content');
            if (!noticeContentElement) return;

            const today = new Date();
            // ì´ë²ˆ ì£¼ì˜ ì‹œì‘(ì¼ìš”ì¼)ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
            const startOfWeek = new Date(today);
            startOfWeek.setDate(startOfWeek.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0); // ë‚ ì§œì˜ ì‹œì‘ ì‹œê°„ìœ¼ë¡œ ì„¤ì •

            const weeklyVideos = videos.filter(video => {
                if (!video.createdAt || typeof video.createdAt.toDate !== 'function') {
                    if (video.createdAt instanceof Date) {
                        return video.createdAt >= startOfWeek;
                    }
                    return false;
                }
                const registrationDate = video.createdAt.toDate();
                return registrationDate >= startOfWeek;
            });

            const weeklyCount = weeklyVideos.length;
            let noticeHtml = '';

            if (weeklyCount > 0) {
                noticeHtml += `<p>ì´ë²ˆ ì£¼ì— ìƒˆë¡œ ë“±ë¡ëœ ì •ë³´ëŠ” ì´ <strong>${weeklyCount}</strong>ê°œì…ë‹ˆë‹¤.</p>`;
                noticeHtml += `<ul class="weekly-notice-list">`;
                weeklyVideos.forEach(video => {
                    const searchTerm = (video.product || '').replace(/'/g, "\\'");
                    noticeHtml += `<li onclick="searchByTerm('${searchTerm}')" title="í´ë¦­í•˜ì—¬ '${searchTerm}' ê²€ìƒ‰">${video.product || 'ì œëª© ì—†ìŒ'}</li>`;
                });
                noticeHtml += `</ul>`;
            } else {
                noticeHtml = `<p>ì´ë²ˆ ì£¼ì— ìƒˆë¡œ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
            
            noticeContentElement.innerHTML = noticeHtml;
        }
        
        // Firestoreì—ì„œ ë™ì˜ìƒ ë°ì´í„° ë¡œë“œ
        async function loadVideosFromFirestore() {
            if (!db) {
                console.error("Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                isLoading = true;
                console.log("Firestoreì—ì„œ ë™ì˜ìƒ ë°ì´í„° ë¡œë“œ ì‹œì‘...");
                
                const snapshot = await db.collection('youtube_videos').orderBy('createdAt', 'desc').get();
                
                videos = [];
                snapshot.forEach(doc => {
                    videos.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log('Firestoreì—ì„œ ë¡œë“œëœ ë™ì˜ìƒ ìˆ˜:', videos.length);
                
                // UI ì—…ë°ì´íŠ¸
                displayWeeklyNotice();
                resetSearchResults();
                loadDataTable();
                
            } catch (error) {
                console.error('Firestoreì—ì„œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showConnectionStatus("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + error.message, "error");
            } finally {
                isLoading = false;
            }
        }

        // Firestoreì— ë™ì˜ìƒ ì¶”ê°€
        async function addVideoToFirestore(videoData) {
            if (!db) {
                alert('Firebaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }

            try {
                const docData = {
                    ...videoData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('youtube_videos').add(docData);
                console.log("ë¬¸ì„œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ID:", docRef.id);
                
                // ë¡œì»¬ ë°°ì—´ì—ë„ ì¶”ê°€
                videos.unshift({
                    id: docRef.id,
                    ...videoData,
                    createdAt: new Date()
                });
                
                return true;
            } catch (error) {
                console.error("Firestoreì— ì¶”ê°€ ì‹¤íŒ¨:", error);
                alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                return false;
            }
        }

        // Firestoreì—ì„œ ë™ì˜ìƒ ì—…ë°ì´íŠ¸
        async function updateVideoInFirestore(id, videoData) {
            if (!db) {
                alert('Firebaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }

            try {
                const docData = {
                    ...videoData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('youtube_videos').doc(id).update(docData);
                console.log("ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ID:", id);
                
                // ë¡œì»¬ ë°°ì—´ì—ì„œë„ ì—…ë°ì´íŠ¸
                const index = videos.findIndex(v => v.id === id);
                if (index !== -1) {
                    videos[index] = { ...videos[index], ...videoData };
                }
                
                return true;
            } catch (error) {
                console.error("Firestore ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                alert('ë°ì´í„° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                return false;
            }
        }

        // Firestoreì—ì„œ ë™ì˜ìƒ ì‚­ì œ
        async function deleteVideoFromFirestore(id) {
            if (!db) {
                alert('Firebaseì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return false;
            }

            try {
                await db.collection('youtube_videos').doc(id).delete();
                console.log("ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ID:", id);
                
                // ë¡œì»¬ ë°°ì—´ì—ì„œë„ ì‚­ì œ
                videos = videos.filter(v => v.id !== id);
                
                return true;
            } catch (error) {
                console.error("Firestore ì‚­ì œ ì‹¤íŒ¨:", error);
                alert('ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                return false;
            }
        }

        // DB ê´€ë¦¬ í˜ì´ì§€ ë¹„ë°€ë²ˆí˜¸ ê¸°ëŠ¥ ì¶”ê°€
        function showPage(pageName, buttonElement) {
            if (pageName === 'manage') {
                const adminPassword = "1234"; 
                const userInput = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

                if (userInput === null || userInput === "") {
                    return; 
                }
                
                if (userInput !== adminPassword) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(pageName + '-page').classList.add('active');
            buttonElement.classList.add('active');
            
            if (pageName === 'manage') {
                loadDataTable();
            }
        }

        // ì‹¤ì‹œê°„ ê²€ìƒ‰ ì²˜ë¦¬
        function handleRealTimeSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('unified-search').value.trim();
                if (searchTerm.length > 0) {
                    searchVideos(false);
                } else {
                    resetSearchResults();
                }
            }, 300);
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
        function resetSearchResults() {
            if (isLoading) {
                document.getElementById('search-results').innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            } else if (videos.length === 0) {
                document.getElementById('search-results').innerHTML = '<div class="no-results">ì €ì¥ëœ ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤. DB ê´€ë¦¬ì—ì„œ ë™ì˜ìƒì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>';
            } else {
                displaySearchResults(videos);
            }
            document.getElementById('search-count').style.display = 'none';
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function searchVideos(addToRecent = true) {
            const searchTerm = document.getElementById('unified-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                resetSearchResults();
                return;
            }

            if (addToRecent) {
                addRecentSearch(searchTerm);
            }

            const filteredVideos = videos.filter(video => {
                return (
                    (video.country && video.country.toLowerCase().includes(searchTerm)) ||
                    (video.region && video.region.toLowerCase().includes(searchTerm)) ||
                    (video.brand && video.brand.toLowerCase().includes(searchTerm)) ||
                    (video.product && video.product.toLowerCase().includes(searchTerm)) ||
                    (video.tag && video.tag.toLowerCase().includes(searchTerm))
                );
            });

            document.getElementById('result-count').textContent = filteredVideos.length;
            document.getElementById('search-count').style.display = 'block';

            displaySearchResults(filteredVideos);
        }

        // ê³µì§€ì‚¬í•­ ë¦¬ìŠ¤íŠ¸ í•­ëª© í´ë¦­ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
        function searchByTerm(term) {
            if (!term) return;
            document.getElementById('unified-search').value = term;
            searchVideos();
        }

        // ì—”í„°í‚¤ ê²€ìƒ‰ ì§€ì›
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                searchVideos();
            }
        }

        // ìµœê·¼ ê²€ìƒ‰ì–´ ì¶”ê°€
        function addRecentSearch(searchTerm) {
            recentSearches = recentSearches.filter(item => item !== searchTerm);
            recentSearches.unshift(searchTerm);
            if (recentSearches.length > 10) {
                recentSearches = recentSearches.slice(0, 10);
            }
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        }

        // ìµœê·¼ ê²€ìƒ‰ì–´ í‘œì‹œ
        function showRecentSearches() {
            const dropdown = document.getElementById('recent-searches');
            const recentList = document.getElementById('recent-list');
            
            if (recentSearches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            let recentHtml = '';
            recentSearches.forEach((search, index) => {
                recentHtml += '<div class="recent-item" onclick="selectRecentSearch(\'' + 
                    search.replace(/'/g, "\\'") + '\')">' +
                    '<span class="recent-text">' + search + '</span>' +
                    '<button class="recent-delete" onclick="event.stopPropagation(); deleteRecentSearch(' + index + ')">Ã—</button>' +
                    '</div>';
            });

            recentList.innerHTML = recentHtml;
            dropdown.style.display = 'block';
        }

        // ìµœê·¼ ê²€ìƒ‰ì–´ ì„ íƒ
        function selectRecentSearch(searchTerm) {
            document.getElementById('unified-search').value = searchTerm;
            hideRecentSearches();
            searchVideos();
        }

        // ìµœê·¼ ê²€ìƒ‰ì–´ ê°œë³„ ì‚­ì œ
        function deleteRecentSearch(index) {
            recentSearches.splice(index, 1);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            showRecentSearches();
        }

        // ìµœê·¼ ê²€ìƒ‰ì–´ ì „ì²´ ì‚­ì œ
        function clearRecentSearches() {
            recentSearches = [];
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            hideRecentSearches();
        }

        // ìµœê·¼ ê²€ìƒ‰ì–´ ìˆ¨ê¸°ê¸°
        function hideRecentSearches() {
            setTimeout(() => {
                document.getElementById('recent-searches').style.display = 'none';
            }, 150);
        }

        // ë™ì˜ìƒ ì¶”ê°€
        async function addVideo() {
            const youtubeUrl = document.getElementById('youtube-url').value.trim();
            const country = document.getElementById('country').value.trim();
            const region = document.getElementById('region').value.trim();
            const brand = document.getElementById('brand').value.trim();
            const product = document.getElementById('product').value.trim();
            const tag = document.getElementById('tag').value.trim();

            if (!youtubeUrl) {
                alert('ìœ íŠœë¸Œ URLì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            const addBtn = document.getElementById('add-btn');
            addBtn.disabled = true;
            addBtn.textContent = 'ì¶”ê°€ ì¤‘...';

            const videoData = {
                youtubeUrl: youtubeUrl,
                country: country,
                region: region,
                brand: brand,
                product: product,
                tag: tag
            };

            const success = await addVideoToFirestore(videoData);
            
            if (success) {
                clearForm();
                loadDataTable();
                displayWeeklyNotice();
                showManageStatus('ë™ì˜ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            addBtn.disabled = false;
            addBtn.textContent = 'ì¶”ê°€';
        }

        // ë™ì˜ìƒ ìˆ˜ì •
        function editVideo(index) {
            editingIndex = index;
            editingId = videos[index].id;
            const video = videos[index];
            
            document.getElementById('youtube-url').value = video.youtubeUrl || '';
            document.getElementById('country').value = video.country || '';
            document.getElementById('region').value = video.region || '';
            document.getElementById('brand').value = video.brand || '';
            document.getElementById('product').value = video.product || '';
            document.getElementById('tag').value = video.tag || '';
            
            document.getElementById('add-btn').style.display = 'none';
            document.getElementById('update-btn').style.display = 'inline-block';
            document.getElementById('cancel-btn').style.display = 'inline-block';
        }

        // ë™ì˜ìƒ ì—…ë°ì´íŠ¸
        async function updateVideo() {
            if (editingIndex === -1 || !editingId) return;
            
            const youtubeUrl = document.getElementById('youtube-url').value.trim();
            if (!youtubeUrl) {
                alert('ìœ íŠœë¸Œ URLì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            const updateBtn = document.getElementById('update-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'ìˆ˜ì • ì¤‘...';

            const videoData = {
                youtubeUrl: youtubeUrl,
                country: document.getElementById('country').value.trim(),
                region: document.getElementById('region').value.trim(),
                brand: document.getElementById('brand').value.trim(),
                product: document.getElementById('product').value.trim(),
                tag: document.getElementById('tag').value.trim()
            };

            const success = await updateVideoInFirestore(editingId, videoData);
            
            if (success) {
                cancelEdit();
                loadDataTable();
                showManageStatus('ë™ì˜ìƒì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            updateBtn.disabled = false;
            updateBtn.textContent = 'ìˆ˜ì •';
        }

        // ìˆ˜ì • ì·¨ì†Œ
        function cancelEdit() {
            editingIndex = -1;
            editingId = null;
            clearForm();
            
            document.getElementById('add-btn').style.display = 'inline-block';
            document.getElementById('update-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // ë™ì˜ìƒ ì‚­ì œ
        async function deleteVideo(index) {
            if (!confirm('ì •ë§ë¡œ ì´ ë™ì˜ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const videoId = videos[index].id;
            const success = await deleteVideoFromFirestore(videoId);
            
            if (success) {
                loadDataTable();
                displayWeeklyNotice();
                showManageStatus('ë™ì˜ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        // í¼ ì´ˆê¸°í™”
        function clearForm() {
            document.getElementById('youtube-url').value = '';
            document.getElementById('country').value = '';
            document.getElementById('region').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('product').value = '';
            document.getElementById('tag').value = '';
        }

        // í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
        function copyToClipboard(text, buttonElement) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = 'ë³µì‚¬ ì™„ë£Œ!';
                buttonElement.disabled = true;
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.disabled = false;
                }, 1500);
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            document.body.removeChild(textArea);
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(filteredVideos) {
            const resultsContainer = document.getElementById('search-results');
            
            if (filteredVideos.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">í‘œì‹œí•  ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            let html = '<div class="video-grid">';
            filteredVideos.forEach((video) => {
                const videoId = extractVideoId(video.youtubeUrl);
                const thumbnailUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg` : '';
                const fallbackUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : 'https://via.placeholder.com/350x200.png?text=No+Image';
                
                html += `
                    <div class="video-card">
                        <img src="${thumbnailUrl}" alt="Video thumbnail" class="video-thumbnail" onerror="this.onerror=null; this.src='${fallbackUrl}';">
                        <div class="video-info">
                            <div class="video-title">${video.product || 'ì œëª© ì—†ìŒ'}</div>
                            <div class="video-meta">
                                ${video.country ? `<span class="meta-tag">ğŸŒ ${video.country}</span>` : ''}
                                ${video.region ? `<span class="meta-tag">ğŸ“ ${video.region}</span>` : ''}
                                ${video.brand ? `<span class="meta-tag">ğŸ¢ ${video.brand}</span>` : ''}
                                ${video.tag ? `<span class="meta-tag">ğŸ·ï¸ ${video.tag}</span>` : ''}
                            </div>
                            <div class="video-actions">
                                <button class="btn watch-btn" onclick="window.open('${video.youtubeUrl}', '_blank')">
                                    ğŸ¥ ë™ì˜ìƒ ë³´ê¸°
                                </button>
                                <button class="btn copy-btn" onclick="copyToClipboard('${video.youtubeUrl}', this)">
                                    ğŸ”— ë§í¬ ë³µì‚¬
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            resultsContainer.innerHTML = html;
        }

        // YouTube ë™ì˜ìƒ ID ì¶”ì¶œ (Shorts ë“± ë‹¤ì–‘í•œ URL í˜•ì‹ ì§€ì›)
        function extractVideoId(url) {
            if (!url) return null;
            let videoId = null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|shorts\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                videoId = match[2];
            }
            return videoId;
        }

        // ë°ì´í„° í…Œì´ë¸” ë¡œë“œ
        function loadDataTable() {
            const tableBody = document.getElementById('data-table-body');
            
            if (videos.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-results">ì €ì¥ëœ ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            let html = '';
            videos.forEach((video, index) => {
                html += `
                    <tr>
                        <td><a href="${video.youtubeUrl}" target="_blank" style="color: #667eea; text-decoration: none;" title="${video.youtubeUrl}">${video.youtubeUrl.substring(0, 50)}...</a></td>
                        <td>${video.country || '-'}</td>
                        <td>${video.region || '-'}</td>
                        <td>${video.brand || '-'}</td>
                        <td>${video.product || '-'}</td>
                        <td>${video.tag || '-'}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editVideo(${index})">ìˆ˜ì •</button>
                            <button class="action-btn delete-btn" onclick="deleteVideo(${index})">ì‚­ì œ</button>
                            <button class="action-btn copy-btn-table" onclick="copyToClipboard('${video.youtubeUrl}', this)">ë³µì‚¬</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ì´ˆê¸°í™” ë° ì´ˆê¸° ë°ì´í„° í‘œì‹œ
        window.addEventListener('load', async () => {
            await initFirebase();
            if (videos.length > 0) {
                displaySearchResults(videos);
            }
        });
    </script>
</body>
</html>
