<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>유튜브 동영상 라이브러리</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-btn.active {
            background-color: #667eea;
            color: white;
        }

        .nav-btn:not(.active) {
            background-color: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .page {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .page.active {
            display: block;
        }
        
        .notice-box {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notice-box span {
            font-size: 20px;
            margin-top: 2px;
        }

        .notice-box p {
            margin: 0;
            color: #034c8a;
            font-weight: 500;
        }
        
        /* [수정됨] 공지사항 리스트 스타일 */
        .weekly-notice-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3열 고정 그리드 */
            gap: 8px; /* 항목 간 간격 */
        }

        .weekly-notice-list li {
            background-color: #fff;
            border: 1px solid #d9e2ff;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .weekly-notice-list li:hover {
            background-color: #f0f8ff;
            transform: translateX(2px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .video-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .video-card:hover {
            transform: translateY(-5px);
        }

        .video-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #eee;
        }

        .video-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .video-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .video-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .meta-tag {
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        .video-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .watch-btn, .copy-btn {
            flex: 1;
        }
        
        .copy-btn {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .action-btn {
            padding: 6px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #000;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        
        .copy-btn-table {
            background-color: #38b2ac;
            color: white;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            font-size: 16px;
        }

        /* 최근 검색어 드롭다운 스타일 */
        .recent-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #e1e1e1;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .recent-header span {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .clear-recent {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .clear-recent:hover {
            background-color: #e9ecef;
        }

        .recent-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-item:hover {
            background-color: #f8f9fa;
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-text {
            color: #333;
            font-size: 14px;
        }

        .recent-delete {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        .recent-delete:hover {
            background-color: #e9ecef;
            color: #666;
        }

        .status-indicator {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-success {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎥 유튜브 동영상 라이브러리</h1>
            <p>Firebase로 모든 기기에서 동기화</p>
        </div>

        <!-- 연결 상태 표시 -->
        <div id="connection-status" class="status-indicator" style="display: none;"></div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showPage('search', this)">🔍 검색</button>
            <button class="nav-btn" onclick="showPage('manage', this)">⚙️ DB 관리</button>
        </div>

        <!-- 검색 페이지 -->
        <div id="search-page" class="page active">
            <h2>금주 업로드영상 </h2>
            
            <!-- 주간 등록 정보 공지사항 -->
            <div id="weekly-notice" class="notice-box">
                <span>📢</span>
                <div id="weekly-notice-content">
                    <p>이번 주 신규 등록 정보를 불러오는 중...</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: end;">
                <div class="form-group" style="flex: 1; margin-bottom: 0; position: relative;">
                     <h2><label>통합 검색</label> </h2>h2>
                    <input type="text" id="unified-search" placeholder="나라, 지역, 브랜드, 상품명, 태그로 검색하세요" 
                           oninput="handleRealTimeSearch()" onkeypress="handleEnterKey(event)" onfocus="showRecentSearches()" onblur="hideRecentSearches()">
                    
                    <!-- 최근 검색어 드롭다운 -->
                    <div id="recent-searches" class="recent-dropdown" style="display: none;">
                        <div class="recent-header">
                            <span>최근 검색어</span>
                            <button onclick="clearRecentSearches()" class="clear-recent">전체삭제</button>
                        </div>
                        <div id="recent-list"></div>
                    </div>
                </div>
                <button class="btn" onclick="searchVideos()" style="height: 46px;">검색</button>
            </div>

            <!-- 검색 결과 개수 -->
            <div id="search-count" style="margin-bottom: 15px; color: #666; display: none;">
                <span id="result-count">0</span>개의 검색 결과
            </div>

            <div id="search-results">
                <div class="loading">Firebase에서 데이터를 불러오는 중...</div>
            </div>
        </div>

        <!-- DB 관리 페이지 -->
        <div id="manage-page" class="page">
            <h2>DB 관리</h2>
            
            <div class="form-group">
                <label>유튜브 URL *</label>
                <input type="url" id="youtube-url" placeholder="https://www.youtube.com/watch?v=..." required>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="form-group">
                    <label>나라</label>
                    <input type="text" id="country" placeholder="예: 일본">
                </div>
                <div class="form-group">
                    <label>지역</label>
                    <input type="text" id="region" placeholder="예: 도쿄">
                </div>
                <div class="form-group">
                    <label>브랜드</label>
                    <input type="text" id="brand" placeholder="예: 스타벅스">
                </div>
                <div class="form-group">
                    <label>상품명</label>
                    <input type="text" id="product" placeholder="예: 사쿠라 라떼">
                </div>
                <div class="form-group">
                    <label>태그</label>
                    <input type="text" id="tag" placeholder="예: 리뷰, 맛집">
                </div>
            </div>

            <div style="margin: 20px 0;">
                <button class="btn" onclick="addVideo()" id="add-btn">추가</button>
                <button class="btn" onclick="updateVideo()" id="update-btn" style="display: none;">수정</button>
                <button class="btn btn-danger" onclick="cancelEdit()" id="cancel-btn" style="display: none;">취소</button>
            </div>

            <div id="manage-status"></div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>유튜브 URL</th>
                        <th>나라</th>
                        <th>지역</th>
                        <th>브랜드</th>
                        <th>상품명</th>
                        <th>태그</th>
                        <th>액션</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <tr>
                        <td colspan="7" class="loading">Firebase에서 데이터를 불러오는 중...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 전역 변수
        let db = null;
        let auth = null;
        let videos = [];
        let editingIndex = -1;
        let editingId = null;
        let recentSearches = JSON.parse(localStorage.getItem('recentSearches')) || [];
        let searchTimeout = null;
        let isLoading = false;

        // Firebase 초기화
        async function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyDF70fNUcEba4YQCLpGiPq75P9_gh9T6kY",
                authDomain: "utube-ebd4e.firebaseapp.com",
                projectId: "utube-ebd4e",
                storageBucket: "utube-ebd4e.appspot.com",
                messagingSenderId: "7974965672",
                appId: "1:7974965672:web:862548a6a5be4093988d9d",
                measurementId: "G-PDZX6N7NNJ"
            };

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                auth = firebase.auth();

                // 익명 로그인
                await auth.signInAnonymously();
                console.log("Firebase 익명 로그인 성공");
                
                showConnectionStatus("Firebase에 연결되었습니다", "connected");
                
                // 데이터 로드
                await loadVideosFromFirestore();
                
            } catch (error) {
                console.error("Firebase 초기화 실패:", error);
                showConnectionStatus("Firebase 연결 실패: " + error.message, "error");
                showOfflineMessage();
            }
        }

        // 연결 상태 표시
        function showConnectionStatus(message, type) {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = message;
            statusElement.className = 'status-indicator status-' + type;
            statusElement.style.display = 'block';
            
            if (type === 'connected') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }

        // 관리 상태 표시
        function showManageStatus(message, type) {
            const statusElement = document.getElementById('manage-status');
            statusElement.textContent = message;
            statusElement.className = 'status-indicator status-' + type;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 오프라인 메시지 표시
        function showOfflineMessage() {
            document.getElementById('search-results').innerHTML = '<div class="error">Firebase 연결에 실패했습니다. 인터넷 연결을 확인해주세요.</div>';
            document.getElementById('data-table-body').innerHTML = '<tr><td colspan="7" class="error">Firebase 연결에 실패했습니다.</td></tr>';
        }

        // 주간 등록 정보 공지사항 및 리스트 표시 함수
        function displayWeeklyNotice() {
            const noticeContentElement = document.getElementById('weekly-notice-content');
            if (!noticeContentElement) return;

            const today = new Date();
            // 이번 주의 시작(일요일)을 계산합니다.
            const startOfWeek = new Date(today);
            startOfWeek.setDate(startOfWeek.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0); // 날짜의 시작 시간으로 설정

            const weeklyVideos = videos.filter(video => {
                if (!video.createdAt || typeof video.createdAt.toDate !== 'function') {
                    if (video.createdAt instanceof Date) {
                        return video.createdAt >= startOfWeek;
                    }
                    return false;
                }
                const registrationDate = video.createdAt.toDate();
                return registrationDate >= startOfWeek;
            });

            const weeklyCount = weeklyVideos.length;
            let noticeHtml = '';

            if (weeklyCount > 0) {
                noticeHtml += `<p>이번 주에 새로 등록된 정보는 총 <strong>${weeklyCount}</strong>개입니다.</p>`;
                noticeHtml += `<ul class="weekly-notice-list">`;
                weeklyVideos.forEach(video => {
                    const searchTerm = (video.product || '').replace(/'/g, "\\'");
                    noticeHtml += `<li onclick="searchByTerm('${searchTerm}')" title="클릭하여 '${searchTerm}' 검색">${video.product || '제목 없음'}</li>`;
                });
                noticeHtml += `</ul>`;
            } else {
                noticeHtml = `<p>이번 주에 새로 등록된 정보가 없습니다.</p>`;
            }
            
            noticeContentElement.innerHTML = noticeHtml;
        }
        
        // Firestore에서 동영상 데이터 로드
        async function loadVideosFromFirestore() {
            if (!db) {
                console.error("Firestore가 초기화되지 않았습니다.");
                return;
            }

            try {
                isLoading = true;
                console.log("Firestore에서 동영상 데이터 로드 시작...");
                
                const snapshot = await db.collection('youtube_videos').orderBy('createdAt', 'desc').get();
                
                videos = [];
                snapshot.forEach(doc => {
                    videos.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                console.log('Firestore에서 로드된 동영상 수:', videos.length);
                
                // UI 업데이트
                displayWeeklyNotice();
                resetSearchResults();
                loadDataTable();
                
            } catch (error) {
                console.error('Firestore에서 데이터 로드 실패:', error);
                showConnectionStatus("데이터 로드 실패: " + error.message, "error");
            } finally {
                isLoading = false;
            }
        }

        // Firestore에 동영상 추가
        async function addVideoToFirestore(videoData) {
            if (!db) {
                alert('Firebase에 연결되지 않았습니다.');
                return false;
            }

            try {
                const docData = {
                    ...videoData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('youtube_videos').add(docData);
                console.log("문서가 추가되었습니다. ID:", docRef.id);
                
                // 로컬 배열에도 추가
                videos.unshift({
                    id: docRef.id,
                    ...videoData,
                    createdAt: new Date()
                });
                
                return true;
            } catch (error) {
                console.error("Firestore에 추가 실패:", error);
                alert('데이터 저장에 실패했습니다: ' + error.message);
                return false;
            }
        }

        // Firestore에서 동영상 업데이트
        async function updateVideoInFirestore(id, videoData) {
            if (!db) {
                alert('Firebase에 연결되지 않았습니다.');
                return false;
            }

            try {
                const docData = {
                    ...videoData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('youtube_videos').doc(id).update(docData);
                console.log("문서가 업데이트되었습니다. ID:", id);
                
                // 로컬 배열에서도 업데이트
                const index = videos.findIndex(v => v.id === id);
                if (index !== -1) {
                    videos[index] = { ...videos[index], ...videoData };
                }
                
                return true;
            } catch (error) {
                console.error("Firestore 업데이트 실패:", error);
                alert('데이터 수정에 실패했습니다: ' + error.message);
                return false;
            }
        }

        // Firestore에서 동영상 삭제
        async function deleteVideoFromFirestore(id) {
            if (!db) {
                alert('Firebase에 연결되지 않았습니다.');
                return false;
            }

            try {
                await db.collection('youtube_videos').doc(id).delete();
                console.log("문서가 삭제되었습니다. ID:", id);
                
                // 로컬 배열에서도 삭제
                videos = videos.filter(v => v.id !== id);
                
                return true;
            } catch (error) {
                console.error("Firestore 삭제 실패:", error);
                alert('데이터 삭제에 실패했습니다: ' + error.message);
                return false;
            }
        }

        // DB 관리 페이지 비밀번호 기능 추가
        function showPage(pageName, buttonElement) {
            if (pageName === 'manage') {
                const adminPassword = "1234"; 
                const userInput = prompt("관리자 비밀번호를 입력하세요:");

                if (userInput === null || userInput === "") {
                    return; 
                }
                
                if (userInput !== adminPassword) {
                    alert("비밀번호가 일치하지 않습니다.");
                    return;
                }
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(pageName + '-page').classList.add('active');
            buttonElement.classList.add('active');
            
            if (pageName === 'manage') {
                loadDataTable();
            }
        }

        // 실시간 검색 처리
        function handleRealTimeSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('unified-search').value.trim();
                if (searchTerm.length > 0) {
                    searchVideos(false);
                } else {
                    resetSearchResults();
                }
            }, 300);
        }

        // 검색 결과 초기화
        function resetSearchResults() {
            if (isLoading) {
                document.getElementById('search-results').innerHTML = '<div class="loading">데이터를 불러오는 중...</div>';
            } else if (videos.length === 0) {
                document.getElementById('search-results').innerHTML = '<div class="no-results">저장된 동영상이 없습니다. DB 관리에서 동영상을 추가해보세요.</div>';
            } else {
                displaySearchResults(videos);
            }
            document.getElementById('search-count').style.display = 'none';
        }

        // 검색 기능
        function searchVideos(addToRecent = true) {
            const searchTerm = document.getElementById('unified-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                resetSearchResults();
                return;
            }

            if (addToRecent) {
                addRecentSearch(searchTerm);
            }

            const filteredVideos = videos.filter(video => {
                return (
                    (video.country && video.country.toLowerCase().includes(searchTerm)) ||
                    (video.region && video.region.toLowerCase().includes(searchTerm)) ||
                    (video.brand && video.brand.toLowerCase().includes(searchTerm)) ||
                    (video.product && video.product.toLowerCase().includes(searchTerm)) ||
                    (video.tag && video.tag.toLowerCase().includes(searchTerm))
                );
            });

            document.getElementById('result-count').textContent = filteredVideos.length;
            document.getElementById('search-count').style.display = 'block';

            displaySearchResults(filteredVideos);
        }

        // 공지사항 리스트 항목 클릭 시 검색 실행
        function searchByTerm(term) {
            if (!term) return;
            document.getElementById('unified-search').value = term;
            searchVideos();
        }

        // 엔터키 검색 지원
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                searchVideos();
            }
        }

        // 최근 검색어 추가
        function addRecentSearch(searchTerm) {
            recentSearches = recentSearches.filter(item => item !== searchTerm);
            recentSearches.unshift(searchTerm);
            if (recentSearches.length > 10) {
                recentSearches = recentSearches.slice(0, 10);
            }
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
        }

        // 최근 검색어 표시
        function showRecentSearches() {
            const dropdown = document.getElementById('recent-searches');
            const recentList = document.getElementById('recent-list');
            
            if (recentSearches.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            let recentHtml = '';
            recentSearches.forEach((search, index) => {
                recentHtml += '<div class="recent-item" onclick="selectRecentSearch(\'' + 
                    search.replace(/'/g, "\\'") + '\')">' +
                    '<span class="recent-text">' + search + '</span>' +
                    '<button class="recent-delete" onclick="event.stopPropagation(); deleteRecentSearch(' + index + ')">×</button>' +
                    '</div>';
            });

            recentList.innerHTML = recentHtml;
            dropdown.style.display = 'block';
        }

        // 최근 검색어 선택
        function selectRecentSearch(searchTerm) {
            document.getElementById('unified-search').value = searchTerm;
            hideRecentSearches();
            searchVideos();
        }

        // 최근 검색어 개별 삭제
        function deleteRecentSearch(index) {
            recentSearches.splice(index, 1);
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            showRecentSearches();
        }

        // 최근 검색어 전체 삭제
        function clearRecentSearches() {
            recentSearches = [];
            localStorage.setItem('recentSearches', JSON.stringify(recentSearches));
            hideRecentSearches();
        }

        // 최근 검색어 숨기기
        function hideRecentSearches() {
            setTimeout(() => {
                document.getElementById('recent-searches').style.display = 'none';
            }, 150);
        }

        // 동영상 추가
        async function addVideo() {
            const youtubeUrl = document.getElementById('youtube-url').value.trim();
            const country = document.getElementById('country').value.trim();
            const region = document.getElementById('region').value.trim();
            const brand = document.getElementById('brand').value.trim();
            const product = document.getElementById('product').value.trim();
            const tag = document.getElementById('tag').value.trim();

            if (!youtubeUrl) {
                alert('유튜브 URL은 필수입니다.');
                return;
            }

            const addBtn = document.getElementById('add-btn');
            addBtn.disabled = true;
            addBtn.textContent = '추가 중...';

            const videoData = {
                youtubeUrl: youtubeUrl,
                country: country,
                region: region,
                brand: brand,
                product: product,
                tag: tag
            };

            const success = await addVideoToFirestore(videoData);
            
            if (success) {
                clearForm();
                loadDataTable();
                displayWeeklyNotice();
                showManageStatus('동영상이 추가되었습니다.', 'success');
            }

            addBtn.disabled = false;
            addBtn.textContent = '추가';
        }

        // 동영상 수정
        function editVideo(index) {
            editingIndex = index;
            editingId = videos[index].id;
            const video = videos[index];
            
            document.getElementById('youtube-url').value = video.youtubeUrl || '';
            document.getElementById('country').value = video.country || '';
            document.getElementById('region').value = video.region || '';
            document.getElementById('brand').value = video.brand || '';
            document.getElementById('product').value = video.product || '';
            document.getElementById('tag').value = video.tag || '';
            
            document.getElementById('add-btn').style.display = 'none';
            document.getElementById('update-btn').style.display = 'inline-block';
            document.getElementById('cancel-btn').style.display = 'inline-block';
        }

        // 동영상 업데이트
        async function updateVideo() {
            if (editingIndex === -1 || !editingId) return;
            
            const youtubeUrl = document.getElementById('youtube-url').value.trim();
            if (!youtubeUrl) {
                alert('유튜브 URL은 필수입니다.');
                return;
            }

            const updateBtn = document.getElementById('update-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = '수정 중...';

            const videoData = {
                youtubeUrl: youtubeUrl,
                country: document.getElementById('country').value.trim(),
                region: document.getElementById('region').value.trim(),
                brand: document.getElementById('brand').value.trim(),
                product: document.getElementById('product').value.trim(),
                tag: document.getElementById('tag').value.trim()
            };

            const success = await updateVideoInFirestore(editingId, videoData);
            
            if (success) {
                cancelEdit();
                loadDataTable();
                showManageStatus('동영상이 수정되었습니다.', 'success');
            }

            updateBtn.disabled = false;
            updateBtn.textContent = '수정';
        }

        // 수정 취소
        function cancelEdit() {
            editingIndex = -1;
            editingId = null;
            clearForm();
            
            document.getElementById('add-btn').style.display = 'inline-block';
            document.getElementById('update-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // 동영상 삭제
        async function deleteVideo(index) {
            if (!confirm('정말로 이 동영상을 삭제하시겠습니까?')) {
                return;
            }

            const videoId = videos[index].id;
            const success = await deleteVideoFromFirestore(videoId);
            
            if (success) {
                loadDataTable();
                displayWeeklyNotice();
                showManageStatus('동영상이 삭제되었습니다.', 'success');
            }
        }

        // 폼 초기화
        function clearForm() {
            document.getElementById('youtube-url').value = '';
            document.getElementById('country').value = '';
            document.getElementById('region').value = '';
            document.getElementById('brand').value = '';
            document.getElementById('product').value = '';
            document.getElementById('tag').value = '';
        }

        // 클립보드 복사 함수
        function copyToClipboard(text, buttonElement) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = '복사 완료!';
                buttonElement.disabled = true;
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.disabled = false;
                }, 1500);
            } catch (err) {
                console.error('클립보드 복사 실패:', err);
                alert('클립보드 복사에 실패했습니다.');
            }
            document.body.removeChild(textArea);
        }

        // 검색 결과 표시
        function displaySearchResults(filteredVideos) {
            const resultsContainer = document.getElementById('search-results');
            
            if (filteredVideos.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">표시할 동영상이 없습니다.</div>';
                return;
            }

            let html = '<div class="video-grid">';
            filteredVideos.forEach((video) => {
                const videoId = extractVideoId(video.youtubeUrl);
                const thumbnailUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg` : '';
                const fallbackUrl = videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : 'https://via.placeholder.com/350x200.png?text=No+Image';
                
                html += `
                    <div class="video-card">
                        <img src="${thumbnailUrl}" alt="Video thumbnail" class="video-thumbnail" onerror="this.onerror=null; this.src='${fallbackUrl}';">
                        <div class="video-info">
                            <div class="video-title">${video.product || '제목 없음'}</div>
                            <div class="video-meta">
                                ${video.country ? `<span class="meta-tag">🌍 ${video.country}</span>` : ''}
                                ${video.region ? `<span class="meta-tag">📍 ${video.region}</span>` : ''}
                                ${video.brand ? `<span class="meta-tag">🏢 ${video.brand}</span>` : ''}
                                ${video.tag ? `<span class="meta-tag">🏷️ ${video.tag}</span>` : ''}
                            </div>
                            <div class="video-actions">
                                <button class="btn watch-btn" onclick="window.open('${video.youtubeUrl}', '_blank')">
                                    🎥 동영상 보기
                                </button>
                                <button class="btn copy-btn" onclick="copyToClipboard('${video.youtubeUrl}', this)">
                                    🔗 링크 복사
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            resultsContainer.innerHTML = html;
        }

        // YouTube 동영상 ID 추출 (Shorts 등 다양한 URL 형식 지원)
        function extractVideoId(url) {
            if (!url) return null;
            let videoId = null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|shorts\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            if (match && match[2].length === 11) {
                videoId = match[2];
            }
            return videoId;
        }

        // 데이터 테이블 로드
        function loadDataTable() {
            const tableBody = document.getElementById('data-table-body');
            
            if (videos.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-results">저장된 동영상이 없습니다.</td></tr>';
                return;
            }

            let html = '';
            videos.forEach((video, index) => {
                html += `
                    <tr>
                        <td><a href="${video.youtubeUrl}" target="_blank" style="color: #667eea; text-decoration: none;" title="${video.youtubeUrl}">${video.youtubeUrl.substring(0, 50)}...</a></td>
                        <td>${video.country || '-'}</td>
                        <td>${video.region || '-'}</td>
                        <td>${video.brand || '-'}</td>
                        <td>${video.product || '-'}</td>
                        <td>${video.tag || '-'}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editVideo(${index})">수정</button>
                            <button class="action-btn delete-btn" onclick="deleteVideo(${index})">삭제</button>
                            <button class="action-btn copy-btn-table" onclick="copyToClipboard('${video.youtubeUrl}', this)">복사</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // 페이지 로드 시 Firebase 초기화 및 초기 데이터 표시
        window.addEventListener('load', async () => {
            await initFirebase();
            if (videos.length > 0) {
                displaySearchResults(videos);
            }
        });
    </script>
</body>
</html>
